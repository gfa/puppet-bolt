#!/bin/bash
set -e
set -o pipefail

cd $(mktemp -d)

for torrent in $(transmission-remote 127.0.0.1:<%= @rpc_port %> -n <%= @rpc_username %>:<%= @rpc_password %> -l 2>/dev/null | awk '$9 == "Finished" {print $1}' | sed 's/*//g'); do
        transmission-remote 127.0.0.1:<%= @rpc_port %> -n <%= @rpc_username %>:<%= @rpc_password %> -t $torrent -r >/dev/null 2>/dev/null
done

sleep 10m

for torrent in $(transmission-remote 127.0.0.1:<%= @rpc_port %> -n <%= @rpc_username %>:<%= @rpc_password %> -l 2>/dev/null | awk '$9 == "Stopped" && $5 == "Done" {print $1}' | sed 's/*//g'); do
        transmission-remote 127.0.0.1:<%= @rpc_port %> -n <%= @rpc_username %>:<%= @rpc_password %> -t $torrent -r >/dev/null 2>/dev/null
done

cd /tmp
rmdir $OLDPWD
